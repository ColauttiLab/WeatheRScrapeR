---
title: "Lythrum"
output: 
  html_document: 
    fig_caption: yes
    fig_width: 8
    toc: yes
---

```{r library setup, include=FALSE}
library(tidyverse)
library(knitr)
library(pander)
library(broom)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)
panderOptions('missing', '')
panderOptions("table.caption.prefix", "")
```

#Data Setup
##Herbarium Data
### Variables
```{r herbarium raw data}
PopData<- read.csv("PopData.csv", header=T)
names(PopData)
```

**Pop_Code**: Specimen barcode.   

**standard**: Length of scale measured in ImageJ.  

**actual**: Length of scale measured in centimeters.   

**fruit.inf.Length**: Length of fruiting influorescence.   

**aborted.inf.length**: Length of aborted influorescence.  

**flower.inf.length**: Length of flowering influorescence.  

**bud.inf.Length**: Length of budding influorescence.  

**Location**: Location described from herbarium label.  

**Date**: Day of collection in yyyy-mm-dd format.  

**Latitude**: Latitude of specimen collection site, given by label, database, or through Google maps using label location.  

**Longitude**: Longitude of specimen collection site, given by label, database, or through Google maps using label location.  

**yday**: The collection date as julian day of the year.  

**Year**: Year of collection.  

##Climate Data


##Local Climate Metrics

```{r calculated season metrics data}
data<-read.csv("HerbariumPopData_GDD_byDay.csv", header=T)
names(data)
```

**GD**: Length of growing season, calculated as the number of days at the collection site above 8°C.  

**GDs**: The number of days from the start of the growing season to the day of collection.  

**GDD**: Cumulative growing degree days over the length of the growing season.  

**GDDs**: Cumulative growing degree days from the start of the growing season to the day of collection.  

**meanGDeg**: The average growing degrees per day over the growing season.  

**varGDeg**: The variance in growing degree days over the growing season.  

**skewGDeg**: The skew in the distribution of growing degree days values over the growing season.  

**kurtGDeg**: The kurtosis in the distribution of growing degree days values over the growing season.  

**numStns**: The number of local weather stations used in the interpolation of temperature values at the site.  


# Estimating Phenology
## Scaling Herbarium Data
```{r scaling herbarium data}
## exclude 'populations' (i.e. sample locations) that are missing climate data
data<-subset(data,!(is.na(data["GD"])))
# calculate actual lengths in cm
# length of flower portion of inflorescence (converting pixels to cm)
data$flower.cm<-data$actual/data$standard*data$flower.inf.length
# length of bud portion of inflorescence
data$bud.cm<-data$actual/data$standard*data$bud.inf.Length
# length of fruit portion of inflorescence
data$fruit.cm<-data$actual/data$standard*data$fruit.inf.Length
# length of aborted flower portion of inflorescence 
data$a.flower.cm<-data$actual/data$standard*data$aborted.inf.length
# length of inflorescence
data$infl.cm<-data$flower.cm+data$bud.cm+data$fruit.cm+data$a.flower.cm
```
## Phenology Index
The **phenology index** is calculated based on the proportion of buds, flowers, and fruits. Fruits have a value of 1, flowers a value of 0, and buds a value of -1. It is a measure of the development of the specimen at the time of collection

$$phind_i = \frac{bud_i - fruit_i - aborted fruit_i}{total influorescence_i}$$

```{r phenology index}
data$phind<-(data$bud.cm-data$fruit.cm-data$a.flower.cm)/data$infl.cm
write.csv(data, "PhenolAllData.csv", row.names=F)
```


## Temporal and Geographic Categories 
Four geographic regions:  

* East Coast: East of 76°W  
* Midwest: Between 76°W and 95°W.  
* West: Between 95°W and 122°W.  
* West Coast: West of 122°W.  

Two time eras:  

* Early: Collected before 1920.
* Middle: Collected between 1921 and 1969
* Recent: Colleted in 1970 or after.   


```{r categorizing specimens by time and location}
PhenolAllData<-read.csv("PhenolAllData.csv", header=T)
## Separate data into east vs. west
PhenolAllData$Region <-NULL
PhenolAllData$Region[PhenolAllData$Longitude > -76]<-"EastCoast"
PhenolAllData$Region[PhenolAllData$Longitude <= -76 & PhenolAllData$Longitude > -95]<-"Midwest"
PhenolAllData$Region[PhenolAllData$Longitude <= -95 & PhenolAllData$Longitude > -122]<-"West"
PhenolAllData$Region[PhenolAllData$Longitude <= -122]<-"WestCoast"
PhenolAllData$Region<-as.factor(PhenolAllData$Region)

## Separate by date
PhenolAllData$Era <-NULL
PhenolAllData$Era[PhenolAllData$Year < 1970]<-"Early"
PhenolAllData$Era[PhenolAllData$Year >= 1920 & PhenolAllData$Year < 1970]<-"Middle"
PhenolAllData$Era[PhenolAllData$Year >= 1970]<-"Recent"
PhenolAllData$Era<-as.factor(PhenolAllData$Era)
tabletande<-table(PhenolAllData$Era, PhenolAllData$Region)
kable(tabletande, caption="Table 1. Number of specimens in each region and era.")

```


```{r collection frequency plot, fig.cap="Histogram of specimens collected categorized by region."}
ggplot(PhenolAllData, aes(Year, fill=Region))+ 
  geom_histogram()
```

## Correlations between growing season and collection day
```{r correlations of GD, echo=TRUE}
cor(PhenolAllData$GD,PhenolAllData$GDs)
cor(PhenolAllData$GDD,PhenolAllData$GDDs)
cor(PhenolAllData$GD,PhenolAllData$GDDs)
cor(PhenolAllData$GDD,PhenolAllData$GDs)
 
```
## Variable Selection for standardization
```{r growing season modelling, echo=TRUE}
summary(lm(phind~GD,data=PhenolAllData))
summary(lm(phind~GDs,data=PhenolAllData)) 
summary(lm(phind~GDs*GD,data=PhenolAllData))
```

Time from start of growing season to collection date (GDs) is a better predictor than season length (GD). After controlling for collection time, the length of the growing season is not a significant predictor of phenology.
```{r growing degree days modelling, echo=TRUE}
summary(lm(phind~GDD,data=PhenolAllData))
summary(lm(phind~GDDs,data=PhenolAllData)) 
summary(lm(phind~GDDs*GDD,data=PhenolAllData))

```
Accumulated growing degree days (GDDs) from start of season to collection date is a better predictor than total accumulated growing degree days over the season (GDD). After controlling for accumulated growing degree days at time of collection, total growing degree days is not a significant predictor of phenology. 

## Flowering Time Index

The flowering time index (fti) adjusts the phenology index for the local climate and the length of time from start of growing season to collection date by standardizing using the accumulated growing degree days from the start of the growing season to the collection date (GDDs). 

```{r fti, echo=TRUE}
PhenolAllData$fti <- (PhenolAllData$phind) + (PhenolAllData$GDDs-mean(PhenolAllData$GDDs,na.rm=TRUE))/sd(PhenolAllData$GDDs,na.rm=TRUE)
write.csv(PhenolAllData, "PhenolAllData.csv", row.names=F)

```

# Clines

```{r Latitudinal cline by region, fig.cap="Figure 1. Regional Flowering Time Index (FTI) clines in specimens before 1960 and after 1960."}
ggplot(PhenolAllData, aes(x=Latitude, y=fti, color=Region)) + 
  facet_grid(Region~Era) +
  geom_point(alpha=0.2, size=2)+
  theme_bw() + 
  theme(plot.background = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = 'black'), legend.position = "none") +
  geom_smooth(method="lm", size=2)
summary(lm(fti~Latitude*Region*Year, data=PhenolAllData)) ## year or era? 

```

There are strong latitudinal FTI clines which vary by region. Specimens collected at lower latitudes have higher FTI than specimens collected from higher latitudes. This implies that specimens from lower latitudes flower later in the growing season while specimens at higher latitudes flowered earlier in their growing season. Both latitude and the geographic region affect the slope of the cline. 

```{r Growing Season clines over latitude by region, fig.cap="Figure 2. Growing Degree Days decreases along a latitudinal cline."}
ggplot(PhenolAllData, aes(x=Latitude, y=GD, color=Region)) + 
  facet_grid(Region~Era) +
  geom_point(alpha=0.2, size=2)+
  theme_bw() + 
  theme(plot.background = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = 'black'), legend.position = "none") +
  geom_smooth(method="lm", size=2)
summary(lm(GD~Latitude+Region+Era, data=PhenolAllData)) ## interaction or independent?
```
The length of the growing season is affected by the latitude. Growing season are shorter at higher latitudes and longer at lower latitudes for all regions.For the two eras with enough specimens (East Coast and Midwest), the slope of the correlation between latitude and the growing season is similar.  

```{r FTI over growing season by region, fig.cap="Figure 3. Regional Flowering Time Index (FTI) clines over growing season."}
ggplot(PhenolAllData, aes(x=GD, y=fti, color=Region)) +
  facet_grid(Region~Era) +
  geom_point(alpha=0.2, size=2)+
  theme_bw() + 
  theme(plot.background = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = 'black'), legend.position = "none") +
  geom_smooth(method="lm", size=2)
summary(lm(fti~GD*Region*Era, data=PhenolAllData))
```
When FTI is plotted against the length of the growing season, specimens from locations with longer growing seasons flower later in their growing season compared to specimens from locations with relatively shorter growing seasons. Additionally, the flowering cline has growen stronger over time, with specimens at locations with longer growing seasons now flowering even later in the growing seasons in the Midwest region.

#Validation

```{r Validation data}
GreenhouseData<-read.csv("MontagueGreenhousePopulations_GDD_byDay.csv", header=T, stringsAsFactors = F)

CommonGarden<-read.csv("CBCommonGarden_GDD_byDay.csv", stringsAsFactors = F)
names(CommonGarden)[1]<-"Individualnumber"

PhenolAllData<-read.csv("PhenolAllData.csv", header=T, stringsAsFactors=FALSE)


## create find and fti for Greenhouse and Field data

GreenhouseData$fti<-(GreenhouseData$yday-mean(GreenhouseData$yday, na.rm=TRUE))/sd(GreenhouseData$yday, na.rm=TRUE)

CommonGarden %>% separate(Plant_ID, c("Sitenumber", "Site1", "Mat", "Row", "Position"), sep="_" ) -> CommonGarden

CommonGarden$Pop<-CommonGarden$Mat # Extract population code from maternal family code
CommonGarden$Pop<-gsub("[0-9]","",CommonGarden$Pop)
## attach origins to common garden data
AllData<-read.table("AllDataFixed.txt", header=T, sep=",")
AllData<-AllData[,c("Pop_Code", "Pop", "Lat")]
names(AllData)<-c("Pop", "Pop_Code", "Lat")
AllData<-unique(AllData)
AllData %>% mutate_if(is.factor, as.character) -> AllData
CommonGarden<-left_join(CommonGarden, AllData)

CommonGarden$find<-(CommonGarden$GDs-mean(CommonGarden$GDs, na.rm=TRUE))/sd(CommonGarden$GDs, na.rm=TRUE)
CommonGarden$fti<- (CommonGarden$find) + (CommonGarden$GDDs-mean(CommonGarden$GDDs,na.rm=TRUE))/sd(CommonGarden$GDDs,na.rm=TRUE)



##Subset data frames
GreenhouseData<-GreenhouseData[,c("Pop_Code", "Latitude", "Longitude", "yday", "Year", "GD", "GDs", "GDD", "GDDs", "meanGDeg","varGDeg", "skewGDeg","kurtGDeg", "numStns", "fti")]
CommonGarden<- CommonGarden[,c("Pop_Code","Longitude","yday", "Year", "GD", "GDs", "GDD", "GDDs", "meanGDeg","varGDeg", "skewGDeg","kurtGDeg", "numStns", "fti", "Lat", "Site1")]

##change years here, will see different slopes for herbarium. Herbarium slope flattens out in more recent years, ie 1990, 2000
PhenolAllData<-subset(PhenolAllData, Year >=1960)
ValidHerb<-PhenolAllData[(PhenolAllData$Latitude < 49) & (PhenolAllData$Longitude > -85), ]
ValidHerb<-ValidHerb[(ValidHerb$Latitude > 38) & (ValidHerb$Longitude < -74), ]
HerbData<-ValidHerb[,c("Pop_Code", "Latitude", "Longitude", "yday", "Year", "GD", "GDs", "GDD", "GDDs", "meanGDeg","varGDeg", "skewGDeg","kurtGDeg", "numStns", "fti")]

##Attach data source as columns to all data frames

GreenhouseData$Source<-"Greenhouse"
#FieldData$Source<-"Field"
HerbData$Source<-"Herbarium"
#CommonGarden$Source<-"CommonGarden"
names(CommonGarden)[15]<-"Latitude"
names(CommonGarden)[16]<-"Source"
##bind all three data frames
AllData<-rbind(GreenhouseData, CommonGarden, HerbData)




```

```{r Validation plot}
ggplot(AllData, aes(x=Latitude, y=fti, color=Source))+
  geom_point(alpha=0.2)+geom_smooth(method="lm")

```

## sandbox
```{r scratch}
mod1<-lm(fti~GD+Era, data=PhenolAllData[PhenolAllData$Region=="EastCoast",])
mod2<-lm(fti~GD*Era, data=PhenolAllData[PhenolAllData$Region=="EastCoast",])
anova(mod1,mod2)
summary(mod2)

mod3<-lm(fti~GD+Era, data=PhenolAllData[PhenolAllData$Region=="Midwest",])
mod4<-lm(fti~GD*Era, data=PhenolAllData[PhenolAllData$Region=="Midwest",])
anova(mod3,mod4)
summary(mod3)

PhenolAllData %>% group_by(Era, Region) %>% do(model=lm(fti~GD, data=.)) -> GDregress
GDcoefficients<- GDregress %>% tidy(model)

ggplot(PhenolAllData, aes(x=GD, y=fti, color=Region)) + 
  facet_grid(Region~.) +
  geom_point(alpha=0.2, size=2)+
  theme_bw() + 
  theme(plot.background = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(color = 'black'), legend.position = "none") +
  geom_smooth(method="lm", size=2)


```

